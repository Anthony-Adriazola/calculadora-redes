@using CalculadoraRedes.Client.Services

@page "/Atenuacion"
@using System.Globalization
@inject HistorialService HistorialService

<h3 style="color: var(--text-color);">Calculadora de Atenuación</h3>

<div style="background-color: var(--secondary-color); padding: 1rem; border-radius: 8px;">
    <label style="color: var(--text-color);">Potencia de transmisión OLT:</label>
    <select @bind="potenciaOLTSeleccion" style="background-color: var(--primary-color); color: var(--text-color); border: 1px solid var(--border-color);">
        <option value="3">3 dBm</option>
        <option value="4">4 dBm</option>
        <option value="5">5 dBm</option>
        <option value="otro">Otro..</option>
    </select>

    @if (potenciaOLTSeleccion == "otro")
    {
        <input type="number" step="0.1" @bind="potenciaOLTManual" placeholder="Ingresa potencia (dBm)" style="background-color: var(--primary-color); color: var(--text-color); border: 1px solid var(--border-color);" />
    }
</div>

<div>
    <label style="color: var(--text-color);">Splitters:</label>
    @foreach (var item in splitterSeleccionados)
    {
        <div style="margin-bottom: 1rem;">
            <select @bind="item.Valor" style="background-color: var(--primary-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 4px;">
                <option disabled selected value="0">Selecciona un Splitter</option>
                <option value="3.6">1:2 (3.6 dB)</option>
                <option value="7.2">1:4 (7.2 dB)</option>
                <option value="11">1:8 (11 dB)</option>
                <option value="14">1:16 (14 dB)</option>
                <option value="17.5">1:32 (17.5 dB)</option>
            </select>
            <button @onclick="() => EliminarSplitter(item)" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">❌</button>
        </div>
    }
    <button @onclick="AgregarSplitter" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">➕</button>
</div>

<div>
    <label style="color: var(--text-color);">Fusiones:</label>
    <button @onclick="() => fusiones++" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">➕</button>
    <span style="color: var(--text-color);">@fusiones</span>
    <button @onclick="() => fusiones = Math.Max(0, fusiones - 1)" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">➖</button>
</div>

<div>
    <label style="color: var(--text-color);">Acopladores:</label>
    <button @onclick="() => acopladores++" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">➕</button>
    <span style="color: var(--text-color);">@acopladores</span>
    <button @onclick="() => acopladores = Math.Max(0, acopladores - 1)" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">➖</button>
</div>

<div>
    <label style="color: var(--text-color);">Longitud del cable (m):</label>
    <button @onclick="() => longitud++" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">➕</button>
    <span style="color: var(--text-color);">@longitud</span>
    <button @onclick="() => longitud = Math.Max(0, longitud - 1)" style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer;">➖</button>
</div>

<button @onclick="CalcularAtenuacion">Calcular</button>

@if (resultado != null)
{
    <p><strong>Atenuación total:</strong> @($"{resultado:F2}") dB</p>
    <p><strong>Potencia de recepción:</strong> @($"{(ObtenerPotenciaOLT() - resultado.Value):F2}") dBm</p>
}

@code {
    class SplitterSeleccionado
    {
        public string Valor { get; set; } = "0";
    }

    List<SplitterSeleccionado> splitterSeleccionados = new() { new SplitterSeleccionado() };

    int fusiones = 0;
    int acopladores = 0;
    double longitud = 0;

    string potenciaOLTSeleccion = "3";
    double? potenciaOLTManual = null;
    double? resultado = null;

    void AgregarSplitter()
    {
        splitterSeleccionados.Add(new SplitterSeleccionado());
    }

    void EliminarSplitter(SplitterSeleccionado splitter)
    {
        if (splitterSeleccionados.Count > 1)
        {
            splitterSeleccionados.Remove(splitter);
        }
    }

    double ObtenerPotenciaOLT()
    {
        if (potenciaOLTSeleccion == "otro")
        {
            return potenciaOLTManual ?? 0;
        }

        return double.Parse(potenciaOLTSeleccion, CultureInfo.InvariantCulture);
    }

    void CalcularAtenuacion()
    {
        double totalSplitters = 0;

        foreach (var splitter in splitterSeleccionados)
        {
            if (double.TryParse(splitter.Valor, NumberStyles.Float, CultureInfo.InvariantCulture, out double valor))
            {
                totalSplitters += valor;
            }
        }

        double AtenuacionFusiones = fusiones * 0.03;
        double AtenuacionAcopladores = acopladores * 0.5;
        double AtenuacionFibra = (longitud / 1000) * 0.2;

        double total = AtenuacionFusiones + AtenuacionAcopladores + AtenuacionFibra + totalSplitters;

        resultado = Math.Round(total, 2);

        double PotenciaRecibida = ObtenerPotenciaOLT() - resultado.Value;

        HistorialService.Agregar(new CalculoAtenuacion
        {
            totalSplitters = totalSplitters,
            Fusiones = fusiones,
            Acopladores = acopladores,
            LongitudCable = longitud,
            AtenuacionTotal = total,
            PotenciaRecibida = PotenciaRecibida
        });
    }
}
