@using CalculadoraRedes.Client.Services
@using Microsoft.JSInterop

@page "/historial"
@inject CalculadoraRedes.Client.Services.HistorialService HistorialService
@inject IJSRuntime JS

<h3 style="color: var(--text-color);">Historial de c√°lculos</h3>

@if (!HistorialService.Historial.Any())
{
    <p style="color: var(--text-color);">No hay c√°lculos registrados.</p>
}
else
{
    <button style="background-color: var(--accent-color); color: var(--text-color); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;" @onclick="LimpiarHistorial">üóëÔ∏è Limpiar historial</button>

    <ul style="list-style: none; padding: 0;">
        @foreach (var item in HistorialService.Historial)
        {
            <li style="margin-bottom: 1rem; background-color: var(--secondary-color); padding: 1rem; border-radius: 8px;">
                <div style="color: var(--text-color);">Splitters: @($"{item.totalSplitters:F2} dB")</div>
                <div style="color: var(--text-color);">Fusiones: @($"{item.AtenuacionFusiones:F2} dB") (@($"{item.Fusiones} x 0.03"))</div>
                <div style="color: var(--text-color);">Acopladores: @($"{item.AtenuacionAcopladores:F2} dB") (@($"{item.Acopladores} x 0.5"))</div>
                <div style="color: var(--text-color);">Fibra √≥ptica: @($"{item.AtenuacionFibra:F2} dB") (@($"{item.LongitudCable}/1000 x 0.2 dB"))</div>
                <strong style="color: var(--text-color);">Atenuaci√≥n total:</strong> @($"{item.AtenuacionTotal:F2} dB") <br />
                <strong style="color: var(--text-color);">Potencia recibida:</strong> @($"{item.PotenciaRecibida:F2} dBm") <br />
            </li>
        }
    </ul>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        await CargarHistorialAsync();
    }

    async Task GuardarHistorialAsync()
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "historialAtenuacion", System.Text.Json.JsonSerializer.Serialize(HistorialService.Historial));
    }

    async Task CargarHistorialAsync()
    {
        var json = await JS.InvokeAsync<string>("localStorage.getItem", "historialAtenuacion");
        if (!string.IsNullOrEmpty(json))
        {
            var historial = System.Text.Json.JsonSerializer.Deserialize<List<CalculoAtenuacion>>(json);
            if (historial != null)
            {
                var propiedad = HistorialService?.GetType().GetProperty("Historial");
                if (propiedad != null)
                {
                    propiedad.SetValue(HistorialService, historial);
                }
            }
        }
    }

    async void LimpiarHistorial()
    {
        HistorialService.Limpiar();
        await GuardarHistorialAsync();
        StateHasChanged();
    }
}
